<!DOCTYPE html>
<html lang="en">
<title>City3D</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="index.css">
<body>
<div class="f4 f1-ns fw4 ma4">City<sup class="h-25 fw1">3d</sup></div>

<div class="flex flex-column ma4 vh-50 vh-75-l overflow-hidden">
    <canvas class="h-inherit" tabindex='1' id="scene"></canvas>
</div>

<script id="vertexShader" type="x-shader/x-vertex">
    #version 300 es
    precision mediump float;
    in vec4 position;
    uniform mat4 mvp;
    uniform int gridSize;
    flat out int fRandomInteger;

    #define SMALL_PRIME 3209
    #define LARGE_PRIME 9967

    float scale(float n, float inMin, float inMax, float outMin, float outMax) {
        return ((n - inMin) * (outMax - outMin)) / ((inMax - inMin) + outMin);
    }

    float randomValueNormalized(int n) {
        return fract(sin(float(gl_InstanceID))*100000.0);
    }

    void main() {
        //
        // Building Position
        //

        float randomValue = randomValueNormalized(gl_InstanceID);
        int randomIndex = int(scale(randomValue, 0.0, 1.0, 0.0, float(gridSize * gridSize)));

        // 1D Index to 2D Index 
        float col = float(randomIndex % gridSize) + 0.5;
        float row = float(randomIndex / gridSize) + 0.5;

        float halfOfGrid = float(gridSize) * 0.5f;
        col = scale(col, 0.0, float(gridSize), -halfOfGrid, halfOfGrid);
        row = scale(row, 0.0, float(gridSize), -halfOfGrid, halfOfGrid);

        vec4 buildingOffset = vec4(col, 0, row, 0);
        vec4 sceneOffset = vec4(-gridSize, 0, -gridSize, 0);

        //
        // Building Height
        //


        float randomHeight = scale(
            float((randomIndex * LARGE_PRIME) % SMALL_PRIME), 
            0.0, 
            float(SMALL_PRIME), 
            0.0, 128.0
        );

        int randomColor = int(scale(
            float(int(float(int(randomValueNormalized(randomIndex)) * LARGE_PRIME)) % SMALL_PRIME),
            0.0, 
            float(SMALL_PRIME), 
            0.0, 16000000.0
        ));


        vec4 pos = position;
        pos.y += (randomHeight / 2.0) * (pos.y < 0.0 ? 0.0 : 1.0);

        gl_Position = mvp * (sceneOffset + buildingOffset + pos);

        fRandomInteger = 376063;
    }
</script>

<script id="fragmentShader" type="x-shader/x-fragment">
    #version 300 es
    precision mediump float;
    flat in int fRandomInteger;
    out vec4 outColor;

    vec3 unpackColor(int c) {
        vec3 color;
        color.r = float((c >> 16) & 255) / 255.0;
        color.g = float((c >> 8) & 255) / 255.0;
        color.b = float(c & 255) / 255.0;
        return color;
    }

    void main() {
        outColor = vec4(unpackColor(fRandomInteger), 1);
    }
</script>

</body>
</html>